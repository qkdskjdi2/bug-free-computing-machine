name: Ultimate-Win10-CRD-Counter-Optimized

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022
    steps:
      
      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 1: ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      # -----------------------------------------------------------
      - name: Install Prerequisites (Chrome, CRD, VBox)
        shell: pwsh
        run: |
          Write-Host "â¬‡ï¸ Downloading Chrome..."
          Invoke-WebRequest -Uri "https://dl.google.com/chrome/install/latest/chrome_installer.exe" -OutFile "chrome_installer.exe"
          Start-Process -FilePath "chrome_installer.exe" -Args "/silent /install" -Wait
          
          Write-Host "â¬‡ï¸ Downloading CRD Host..."
          Invoke-WebRequest -Uri "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"
          Start-Process -FilePath "msiexec.exe" -Args "/i crd.msi /quiet /qn" -Wait

          Write-Host "â¬‡ï¸ Downloading VirtualBox..."
          $vboxUrl = "https://download.virtualbox.org/virtualbox/6.1.48/VirtualBox-6.1.48-159471-Win.exe"
          (New-Object System.Net.WebClient).DownloadFile($vboxUrl, "VirtualBox-Setup.exe")
          Start-Process -FilePath "VirtualBox-Setup.exe" -Args "--silent --ignore-reboot" -Wait
          Write-Host "âœ… All Software Installed Successfully."

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 2: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯
      # -----------------------------------------------------------
      - name: Manage External Counter (Gist)
        shell: pwsh
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          $headers = @{ "Authorization" = "token $env:GIST_TOKEN"; "Accept" = "application/vnd.github.v3+json" }
          $url = "https://api.github.com/gists/$env:GIST_ID"
          $success = $false
          
          while (-not $success) {
              try {
                  $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get -ErrorAction Stop
                  $currentCount = [int]$response.files."counter.txt".content
                  $newCount = $currentCount + 1
                  
                  $body = @{ files = @{ "counter.txt" = @{ content = [string]$newCount } } } | ConvertTo-Json -Depth 10
                  Invoke-RestMethod -Uri $url -Headers $headers -Method Patch -Body $body -ErrorAction Stop
                  
                  echo "DEVICE_NUM=$newCount" >> $env:GITHUB_ENV
                  Write-Host "âœ… Counter Updated to: $newCount"
                  $success = $true
              }
              catch {
                  Start-Sleep -Seconds (Get-Random -Minimum 1 -Maximum 5)
              }
          }

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 3: ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±ÙŠÙ…ÙˆØª Ø¯ÙŠØ³ÙƒØªÙˆØ¨
      # -----------------------------------------------------------
      - name: Start Chrome Remote Desktop
        shell: pwsh
        env:
          CRD_CODE: ${{ secrets.CRD_CODE }}
          CRD_PIN: ${{ secrets.CRD_PIN }}
        run: |
          $exePath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          $UniqueName = "${{ github.actor }}-Machine-${{ env.DEVICE_NUM }}"
          
          Write-Host "ğŸš€ STARTING RDP SERVICE: $UniqueName"
          & $exePath --code="$env:CRD_CODE" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="$UniqueName" --pin=$env:CRD_PIN

      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 4: ØªØ­Ù…ÙŠÙ„ ÙˆÙÙƒ Ø§Ù„Ø¶ØºØ· (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø®Ø·Ø£ Ù‡Ù†Ø§)
      # -----------------------------------------------------------
      - name: Download and Extract OS
        shell: cmd
        run: |
          @echo off
          cd /d "%USERPROFILE%\Desktop"
          set "FILE_URL=https://huggingface.co/datasets/gfdg34fsd/rdp/resolve/main/wino.zip"
          echo â¬‡ï¸ Downloading large file...
          curl -L -o BigFile.zip "%FILE_URL%"
          echo ğŸ“¦ Extracting files...
          7z x BigFile.zip -y
          del BigFile.zip
          echo âœ… Download and Extraction Complete.

# -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 5: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ´ØºÙŠÙ„Ù‡ (Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø®)
      # -----------------------------------------------------------
      - name: Register and Start VM
        shell: pwsh
        run: |
          $vboxManage = "$env:ProgramFiles\Oracle\VirtualBox\VBoxManage.exe"
          $winFolder = "$env:USERPROFILE\Desktop\wino"
          
          # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù VBox
          $vboxFile = Get-ChildItem -Path $winFolder -Filter *.vbox -Recurse | Select-Object -First 1
          
          if ($vboxFile) {
              $vmPath = $vboxFile.FullName
              $originalVmName = $vboxFile.BaseName
              
              # 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©
              Write-Host "ğŸ“¦ Registering VM ($originalVmName)..."
              & $vboxManage registervm "$vmPath"

              # 2. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø©
              Write-Host "ğŸš€ Starting VM..."
              & $vboxManage startvm "$originalVmName" --type gui
              
              Write-Host "âœ… VM Started Successfully!"
          } else {
              Write-Error "âŒ Could not find a .vbox file inside the folder."
          }
      # -----------------------------------------------------------
      # Ø®Ø·ÙˆØ© 6: Ø§Ù„Ø¨Ù‚Ø§Ø¡
      # -----------------------------------------------------------
      - name: Keep Alive
        shell: pwsh
        run: |
          Write-Host "âœ… Both VMs are running..."
          while ($true) { Start-Sleep -Seconds 300 }
